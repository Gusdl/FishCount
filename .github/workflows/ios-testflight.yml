name: Fischbestand

on:
  push: { branches: [ main ] }
  workflow_dispatch:

jobs:
  build-and-upload:
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - uses: maxim-lobanov/setup-xcode@v1
        with: { xcode-version: "15.4" }

      - name: Install cert
        env:
          P12_BASE64: ${{ secrets.CERT_P12 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        run: |
          KEYCHAIN=$RUNNER_TEMP/app.keychain-db
          security create-keychain -p "" $KEYCHAIN
          security default-keychain -s $KEYCHAIN
          security unlock-keychain -p "" $KEYCHAIN
          echo "$P12_BASE64" | base64 --decode > cert.p12
          security import cert.p12 -P "$P12_PASSWORD" -A -t agg -f pkcs12 -k $KEYCHAIN
          security set-key-partition-list -S apple-tool:,apple: -s -k "" $KEYCHAIN

      - name: Install provisioning profile
        env:
          MOBILEPROVISION_BASE64: ${{ secrets.MOBILEPROVISION }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$MOBILEPROVISION_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

      - name: Archive
        run: |
          xcodebuild \
            -scheme "Fischbestand" \
            -configuration Release \
            -sdk iphoneos \
            -archivePath $PWD/build/Fischbestand.xcarchive \
            clean archive \
            DEVELOPMENT_TEAM=XDLCKT3P87 \
            PRODUCT_BUNDLE_IDENTIFIER=com.simonmaiwald.fischbestand

      - name: Export IPA
        run: |
          cat > ExportOptions.plist <<'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0"><dict>
            <key>method</key><string>app-store</string>
            <key>teamID</key><string>YOUR_TEAM_ID</string>
            <key>uploadSymbols</key><true/>
            <key>stripSwiftSymbols</key><true/>
          </dict></plist>
          PLIST
          xcodebuild -exportArchive \
            -archivePath $PWD/build/Fischbestand.xcarchive \
            -exportPath  $PWD/build \
            -exportOptionsPlist ExportOptions.plist
          ls -la build

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with: { ruby-version: '3.2', bundler-cache: true }

      - name: Install fastlane
        run: gem install fastlane

      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_KEY_ID:     ${{ secrets.ASC_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID:  ${{ secrets.ASC_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY:    ${{ secrets.ASC_API_KEY_CONTENTS }}
        run: |
          cat > Fastfile <<'RUBY'
          default_platform(:ios)
          platform :ios do
            lane :beta do
              api_key = app_store_connect_api_key(
                key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
                issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
                key_content: ENV["APP_STORE_CONNECT_API_KEY"],
              )
              pilot(api_key: api_key, ipa: "build/Fischbestand.ipa", skip_waiting_for_build_processing: true)
            end
          end
          RUBY
          fastlane ios beta
